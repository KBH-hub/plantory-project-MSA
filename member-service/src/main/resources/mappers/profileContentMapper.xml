<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zero.plantoryprojectbe.profile.ProfileContentMapper">

    <select id="countProfileWrittenAll"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="int">

        SELECT (
        SELECT COUNT(*)
        FROM sharing
        WHERE member_id = #{memberId}
        AND del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ) + (
        SELECT COUNT(*)
        FROM question
        WHERE member_id = #{memberId}
        AND del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ) AS total
    </select>


    <select id="countProfileWrittenSharing"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="int">

        SELECT COUNT(*)
        FROM sharing
        WHERE member_id = #{memberId}
        AND del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>


    <select id="countProfileWrittenQuestion"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="int">

        SELECT COUNT(*)
        FROM question
        WHERE member_id = #{memberId}
        AND del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>


    <select id="countProfileCommentAll"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="int">

        SELECT (
        SELECT COUNT(*)
        FROM comment c
        JOIN sharing s ON c.sharing_id = s.sharing_id
        WHERE c.writer_id = #{memberId}
        AND c.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND s.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ) + (
        SELECT COUNT(*)
        FROM answer a
        JOIN question q ON a.question_id = q.question_id
        WHERE a.writer_id = #{memberId}
        AND a.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND q.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ) AS total
    </select>


    <select id="countProfileCommentSharing"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="int">

        SELECT COUNT(*)
        FROM comment c
        JOIN sharing s ON c.sharing_id = s.sharing_id
        WHERE c.writer_id = #{memberId}
        AND c.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND s.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>


    <select id="countProfileCommentQuestion"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="int">

        SELECT COUNT(*)
        FROM answer a
        JOIN question q ON a.question_id = q.question_id
        WHERE a.writer_id = #{memberId}
        AND a.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND q.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>



    <select id="selectProfileWrittenListAll"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="org.zero.memberservice.profile.dto.ProfileWrittenListResponse">

        SELECT *
        FROM (
        SELECT
        s.sharing_id AS id,
        s.member_id,
        m.nickname,
        s.title,
        s.created_at,
        'SHARING' AS category
        FROM sharing s
        JOIN member m ON s.member_id = m.member_id
        WHERE s.member_id = #{memberId}
        AND s.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND s.title LIKE CONCAT('%', #{keyword}, '%')
        </if>

        UNION ALL

        SELECT
        q.question_id AS id,
        q.member_id,
        m.nickname,
        q.title,
        q.created_at,
        'QUESTION' AS category
        FROM question q
        JOIN member m ON q.member_id = m.member_id
        WHERE q.member_id = #{memberId}
        AND q.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND q.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ) t
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <select id="selectProfileWrittenListSharing"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="org.zero.memberservice.profile.dto.ProfileWrittenListResponse">

        SELECT
        s.sharing_id AS id,
        s.member_id,
        m.nickname,
        s.title,
        s.created_at,
        'SHARING' AS category
        FROM sharing s
        JOIN member m ON s.member_id = m.member_id
        WHERE s.member_id = #{memberId}
        AND s.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND s.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY s.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="selectProfileWrittenListQuestion"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="org.zero.memberservice.profile.dto.ProfileWrittenListResponse">

        SELECT
        q.question_id AS id,
        q.member_id,
        m.nickname,
        q.title,
        q.created_at,
        'QUESTION' AS category
        FROM question q
        JOIN member m ON q.member_id = m.member_id
        WHERE q.member_id = #{memberId}
        AND q.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND q.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY q.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <select id="selectProfileCommentSearchAll"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="org.zero.memberservice.profile.dto.ProfileWrittenListResponse">

        SELECT *
        FROM (
        SELECT
        c.comment_id AS id,
        c.sharing_id AS target_id,     <!-- 핵심: 원글 id -->
        c.writer_id  AS member_id,     <!-- 댓글 작성자 -->
        mw.nickname  AS nickname,      <!-- 댓글 작성자 닉네임 -->
        s.title      AS title,
        c.created_at AS created_at,
        'COMMENT'    AS category
        FROM comment c
        JOIN sharing s ON c.sharing_id = s.sharing_id
        JOIN member mw ON mw.member_id = c.writer_id
        WHERE c.writer_id = #{memberId}
        AND c.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND s.title LIKE CONCAT('%', #{keyword}, '%')
        </if>

        UNION ALL

        SELECT
        a.answer_id   AS id,
        a.question_id AS target_id,
        a.writer_id   AS member_id,
        mw.nickname   AS nickname,
        q.title       AS title,
        a.created_at  AS created_at,
        'ANSWER'      AS category
        FROM answer a
        JOIN question q ON a.question_id = q.question_id
        JOIN member mw  ON mw.member_id = a.writer_id
        WHERE a.writer_id = #{memberId}
        AND a.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND q.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ) t
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <select id="selectProfileCommentSearchSharing"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="org.zero.memberservice.profile.dto.ProfileWrittenListResponse">

        SELECT
        c.comment_id AS id,
        c.sharing_id AS member_id,
        c.writer_id,
        c.created_at,
        s.title,
        m.nickname,
        'COMMENT' AS category
        FROM comment c
        JOIN sharing s ON c.sharing_id = s.sharing_id
        JOIN member m ON s.member_id = m.member_id
        WHERE c.writer_id = #{memberId}
        AND c.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND s.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY c.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <select id="selectProfileCommentSearchQuestion"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenListRequest"
            resultType="org.zero.memberservice.profile.dto.ProfileWrittenListResponse">

        SELECT
        a.answer_id AS id,
        a.question_id AS member_id,
        a.writer_id,
        a.created_at,
        q.title,
        m.nickname,
        'ANSWER' AS category
        FROM answer a
        JOIN question q ON a.question_id = q.question_id
        JOIN member m ON q.member_id = m.member_id
        WHERE a.writer_id = #{memberId}
        AND a.del_flag IS NULL
        <if test="keyword != null and keyword != ''">
            AND q.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY a.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <update id="deleteProfileWrittenSharing"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenDeleteRequest">

        UPDATE sharing
        SET del_flag = NOW()
        WHERE member_id = #{memberId}
        AND sharing_id IN
        <foreach collection="sharingIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>

    </update>


    <update id="deleteProfileWrittenQuestion"
            parameterType="org.zero.memberservice.profile.dto.ProfileWrittenDeleteRequest">

        UPDATE question
        SET del_flag = NOW()
        WHERE member_id = #{memberId}
        AND question_id IN
        <foreach collection="questionIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>

    </update>


</mapper>
