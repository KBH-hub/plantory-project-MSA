<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zero.plantoryprojectbe.message.MessageMapper">

    <select id="selectMessages"
            parameterType="com.zero.plantoryprojectbe.message.dto.MessageSearchRequest"
            resultType="com.zero.plantoryprojectbe.message.dto.MessageListResponse">
        SELECT
        m.message_id,
        m.sender_id,
        sender.nickname   AS sender_nickname,
        m.receiver_id,
        receiver.nickname AS receiver_nickname,
        m.title,
        m.content,
        m.target_type,
        m.target_id,
        m.created_at,
        m.read_flag,
        m.del_flag,
        m.sender_del_flag,
        CASE
        WHEN m.target_type = 'SHARING' THEN (
        SELECT s.title
        FROM sharing s
        WHERE s.sharing_id = m.target_id
        AND s.del_flag  IS NULL
        )
        WHEN m.target_type = 'QUESTION' THEN (
        SELECT q.title
        FROM question q
        WHERE q.question_id = m.target_id
        AND q.del_flag   IS NULL
        )
        ELSE NULL
        END AS target_title,
        COUNT(*) OVER() AS total_count
        FROM message m
        JOIN member sender   ON m.sender_id   = sender.member_id
        JOIN member receiver ON m.receiver_id = receiver.member_id
        <where>
            <if test="boxType != null and boxType.name() == 'RECEIVED'">
                AND m.receiver_id = #{memberId}
                AND m.del_flag IS NULL
            </if>
            <if test="boxType != null and boxType.name() == 'SENT'">
                AND m.sender_id = #{memberId}
                AND m.sender_del_flag IS NULL
            </if>

            <if test="targetType != null">
                AND m.target_type = #{targetType}
            </if>

            <if test="title != null and title != ''">
                AND m.title LIKE CONCAT('%', #{title}, '%')
            </if>
        </where>
        ORDER BY m.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <update id="updateReadFlag">
        UPDATE message
        SET read_flag = NOW()
        WHERE message_id = #{messageId}
    </update>

    <update id="deleteMessages">
        UPDATE message
        SET del_flag = NOW()
        WHERE message_id IN
        <foreach collection="messageIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="deleteSenderMessages">
        UPDATE message
        SET sender_del_flag = NOW()
        WHERE message_id IN
        <foreach collection="messageIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <select id="selectMessageWriteInfo"
            resultType="com.zero.plantoryprojectbe.message.dto.MessageResponse">
        SELECT
            m.message_id,
            m.sender_id,
            sender.nickname   AS sender_nickname,
            m.receiver_id,
            receiver.nickname AS receiver_nickname,
            m.title,
            m.content,
            m.target_type,
            m.target_id,
            m.created_at,
            m.read_flag,
            m.del_flag,
            CASE
                WHEN m.target_type = 'SHARING'  THEN s.title
                WHEN m.target_type = 'QUESTION' THEN q.title
                ELSE NULL
                END AS target_title
        FROM (
                 SELECT
                     m.*,
                     ROW_NUMBER() OVER (
                    PARTITION BY m.sender_id, m.target_type, m.target_id
                    ORDER BY m.created_at DESC, m.message_id DESC
                ) AS rn
                 FROM message m
                 WHERE m.sender_id   = #{senderId}
                   AND m.del_flag    IS NULL
                   AND m.target_type = #{targetType}
                   AND m.target_id   = #{targetId}
             ) m
                 JOIN member sender   ON m.sender_id   = sender.member_id
                 JOIN member receiver ON m.receiver_id = receiver.member_id
                 LEFT JOIN sharing  s ON m.target_type = 'SHARING'
            AND s.sharing_id  = m.target_id
            AND s.del_flag   IS NULL
                 LEFT JOIN question q ON m.target_type = 'QUESTION'
            AND q.question_id = m.target_id
            AND q.del_flag   IS NULL
        WHERE m.rn = 1
    </select>

    <insert id="insertMessage"
            parameterType="com.zero.plantoryprojectbe.message.dto.MessageRequest"
            useGeneratedKeys="true"
            keyProperty="messageId"
            keyColumn="message_id">
        INSERT INTO message
        (sender_id, receiver_id, title, content, target_type, target_id, created_at)
        VALUES
            (#{senderId}, #{receiverId}, #{title}, #{content}, #{targetType}, #{targetId}, NOW())
    </insert>

    <select id="selectMessageDetail"
            resultType="com.zero.plantoryprojectbe.message.dto.MessageResponse">
        SELECT
        m.message_id,
        m.sender_id,
        mem.nickname AS sender_nickname,
        m.receiver_id,
        m.title,
        m.content,
        m.target_type,
        m.target_id,
        m.created_at,
        m.read_flag,
        m.del_flag,
        m.sender_del_flag,
        CASE
        WHEN m.target_type = 'SHARING' THEN (
        SELECT s.title
        FROM sharing s
        WHERE s.sharing_id = m.target_id
        AND s.del_flag IS NULL
        )
        WHEN m.target_type = 'QUESTION' THEN (
        SELECT q.title
        FROM question q
        WHERE q.question_id = m.target_id
        AND q.del_flag IS NULL
        )
        ELSE NULL
        END AS target_title
        FROM message m
        JOIN member mem ON m.sender_id = mem.member_id
        WHERE m.message_id = #{messageId}
    </select>

    <select id="selectReceiveTime">
        select created_at from message
        where sender_id = #{receiverId}
          and target_id = #{targetId}
        order by created_at
            LIMIT 1;
    </select>

    <select id="selectFirstSend">
        select count(message_id) from message
        where sender_id = #{senderId}
          and receiver_id = #{receiverId}
          and target_id = #{targetId};
    </select>

</mapper>
