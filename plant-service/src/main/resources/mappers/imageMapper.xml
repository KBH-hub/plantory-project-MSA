<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zero.plantoryprojectbe.image.ImageMapper">

    <!-- 공통 컬럼 -->
    <sql id="imageColumns">
        image_id,
        member_id,
        target_type,
        target_id,
        file_url,
        file_name,
        created_at,
        del_flag
    </sql>

    <select id="selectSharingThumbnail" resultType="string">
        SELECT file_url
        FROM image
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND del_flag IS NULL
        ORDER BY image_id ASC
        LIMIT 1
    </select>


    <!-- 단건 조회 -->
    <select id="selectImageById" resultType="com.zero.plantoryprojectbe.image.dto.ImageDTO">
        SELECT
        <include refid="imageColumns"/>
        FROM image
        WHERE image_id = #{imageId}
        AND del_flag IS NULL
    </select>


    <!-- 다건 조회 -->
    <select id="selectImagesByTarget" resultType="com.zero.plantoryprojectbe.image.dto.ImageDTO">
        SELECT
        <include refid="imageColumns"/>
        FROM image
        WHERE target_type = #{targetType}
        AND target_id   = #{targetId}
        AND del_flag IS NULL
        ORDER BY image_id ASC
    </select>


    <!-- 이미지 INSERT (GCS 저장 후 DB 저장) -->
    <insert id="insertImage" parameterType="com.zero.plantoryprojectbe.image.dto.ImageDTO">
        INSERT INTO image (
            member_id,
            target_type,
            target_id,
            file_url,
            file_name,
            created_at,
            del_flag
        )
        VALUES (
                   #{memberId},
                   #{targetType},
                   #{targetId},
                   #{fileUrl},
                   #{fileName},
                   NOW(),
                   NULL
               )
    </insert>


    <!-- 단건 이미지 soft delete -->
    <update id="softDeleteImage">
        UPDATE image
        SET del_flag = NOW()
        WHERE image_id = #{imageId}
          AND del_flag IS NULL
    </update>


    <!-- 특정 게시글의 전체 이미지 soft delete -->
    <update id="softDeleteImagesByTarget">
        UPDATE image
        SET del_flag = NOW()
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND del_flag IS NULL
    </update>

    <insert id="insertProfileImage"
            parameterType="com.zero.plantoryprojectbe.image.dto.ImageDTO"
            useGeneratedKeys="true"
            keyProperty="imageId">
        INSERT INTO image (
            member_id,
            target_type,
            target_id,
            file_url,
            file_name,
            created_at,
            del_flag
        )
        VALUES (
                   #{memberId},
                   #{targetType},
                   #{targetId},
                   #{fileUrl},
                   #{fileName},
                   NOW(),
                   NULL
               )
    </insert>

    <select id="selectLatestProfileImage" resultType="com.zero.plantoryprojectbe.image.dto.ImageDTO">
        SELECT
        <include refid="imageColumns"/>
        FROM image
        WHERE target_type = #{targetType}
        AND member_id = #{memberId}
        AND del_flag IS NULL
        ORDER BY created_at DESC, image_id DESC
        LIMIT 1
    </select>


</mapper>
