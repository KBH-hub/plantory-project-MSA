<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zero.plantoryprojectbe.reportManagement.ReportManagementMapper">

    <select id="selectReportTotalCount"
            parameterType="com.zero.plantoryprojectbe.reportManagement.dto.ReportManagementSearchRequest"
            resultType="int">
        SELECT COUNT(*)
        FROM report r
        <where>
            r.del_flag IS NULL
            <if test="keyword != null and keyword != ''">
                AND r.content LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="status != null and status != ''">
                AND r.status = #{status}
            </if>
        </where>
    </select>

    <select id="selectReportList"
            parameterType="com.zero.plantoryprojectbe.reportManagement.dto.ReportManagementSearchRequest"
            resultType="com.zero.plantoryprojectbe.reportManagement.dto.ReportManagementResponse">
        SELECT
        r.report_id,
        r.reporter_id,
        r.target_member_id,
        r.content,
        r.status,
        r.created_at,
        r.admin_memo,
        r.del_flag
        FROM report r
        <where>
            r.del_flag IS NULL
            <if test="keyword != null and keyword != ''">
                AND r.content LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="status != null and status != ''">
                AND r.status = #{status}
            </if>
        </where>
        ORDER BY r.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <update id="deleteReports">
        UPDATE report
        SET del_flag = NOW()
        WHERE del_flag IS NULL
        AND report_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <select id="selectReportDetail" resultType="com.zero.plantoryprojectbe.reportManagement.dto.ReportManagementDetailResponse">
        SELECT
            r.report_id,
            r.reporter_id,
            r.target_member_id,
            reporter.membername AS reporter_name,
            target.membername AS target_name,
            admin.membername AS admin_name,
            r.content,
            r.status,
            r.created_at,
            r.admin_memo
        FROM report r
                 JOIN member reporter ON r.reporter_id = reporter.member_id
                 JOIN member target   ON r.target_member_id = target.member_id
                 LEFT JOIN member admin ON r.admin_id = admin.member_id
        WHERE r.report_id = #{reportId}
          AND r.del_flag IS NULL
    </select>

    <update id="insertAdminMemo">
        UPDATE report
        SET
            admin_id = #{adminId},
            admin_memo = #{adminMemo},
            status = #{status},
            created_at = NOW()
        WHERE report_id = #{reportId}
          AND del_flag IS NULL
    </update>

    <update id="updateStopDay">
        UPDATE member
        <set>
            <choose>
                <when test="days == 0">
                    stop_day = NULL
                </when>
                <otherwise>
                    stop_day = DATE_ADD(NOW(), INTERVAL #{days} DAY)
                </otherwise>
            </choose>
        </set>
        WHERE member_id = #{memberId}
        AND del_flag IS NULL
    </update>

</mapper>